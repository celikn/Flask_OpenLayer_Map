<link rel="stylesheet" href="https://openlayers.org/en/v6.3.1/css/ol.css" type="text/css">
<script src="https://openlayers.org/en/v6.3.1/build/ol.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.1/proj4.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<!-- ol-layerswitcher -->
<script src="https://unpkg.com/ol-layerswitcher@3.5.0"></script>
<link rel="stylesheet" href="https://unpkg.com/ol-layerswitcher@3.5.0/src/ol-layerswitcher.css" />

<link href="https://unpkg.com/ol-geocoder/dist/ol-geocoder.min.css" rel="stylesheet">
<script src="https://unpkg.com/ol-geocoder"></script>

<script src="{{url_for('static', filename='javascript/config.js')}}"></script>

<div class="row-fluid">
  <div class="span12">
    <div id="map" class="map" tabindex="0"></div>
  </div>
</div>

<script>

  var bingKey=config.bingKey;  // big key eklemeyi unutma .)
  var map = new ol.Map({

    layers: [
      new ol.layer.Tile({
        source: new ol.source.OSM()
      })
    ],

    target: 'map',
    controls: ol.control.defaults({
      attribution: false,
      attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
        collapsible: false
      })
    }).extend([new ol.control.ScaleLine(), ]), 
    
    view: new ol.View({
      center: [0, 0],
      zoom: 2
    })
  });

  var basedGroup = new ol.layer.Group({
    // A layer must have a title to appear in the layerswitcher
    title: 'Base maps',
    layers: [
      new ol.layer.Tile({
        title: 'OSM',
        type: 'base',
        visible: true,
        source: new ol.source.OSM()
      }),
      new ol.layer.Tile({
        title: 'BingMap',
        type: 'base',
        preload: Infinity,
        source: new ol.source.BingMaps({
          key: bingKey,
          imagerySet: 'Aerial'

        }),
      }),
    ]
  })

  var overLayesGroup = new ol.layer.Group({
    // A layer must have a title to appear in the layerswitcher
    title: 'Overlays',
    // Adding a 'fold' property set to either 'open' or 'close' makes the group layer
    // collapsible
    fold: 'open',
    layers: [
      new ol.layer.Tile({
        title: 'USA Eyaletler',
        extent: [-13884991, 2870341, -7455066, 6338219],
        source: new ol.source.TileWMS({
          url: 'https://ahocevar.com/geoserver/wms',
          params: { 'LAYERS': 'topp:states', 'TILED': true },
          serverType: 'geoserver',
          // Countries have transparency, so do not fade tiles:
          transition: 0,
        }),
      }),

      new ol.layer.Image({
        // A layer must have a title to appear in the layerswitcher
        title: 'Countries',
        source: new ol.source.ImageArcGISRest({
          ratio: 1,
          params: { LAYERS: 'show:0' },
          url:
            'https://ons-inspire.esriuk.com/arcgis/rest/services/Administrative_Boundaries/Countries_December_2016_Boundaries/MapServer'
        })
      }),
      new ol.layer.Group({
        // A layer must have a title to appear in the layerswitcher
        title: 'Census',
        fold: 'open',
        layers: [
          new ol.layer.Image({
            // A layer must have a title to appear in the layerswitcher
            title: 'Local Authority Districts December 2011 Boundaries',
            source: new ol.source.ImageArcGISRest({
              ratio: 1,
              params: { LAYERS: 'show:0' },
              url:
                'https://ons-inspire.esriuk.com/arcgis/rest/services/Census_Boundaries/Census_Merged_Local_Authority_Districts_December_2011_Boundaries/MapServer'
            })
          }),

        ]
      })
    ]
  })



  var layerSwitcher = new ol.control.LayerSwitcher({
    tipLabel: 'Legand', // Optional label for button
    groupSelectStyle: 'children' // Can be 'children' [default], 'group' or 'none'
  });
  map.addControl(layerSwitcher);

  layerSwitcher.showPanel();
  map.addLayer(basedGroup)
  map.addLayer(overLayesGroup)
  map.addControl(layerSwitcher);



  // Additional Controls
  var zoomToExtentControl = new ol.control.ZoomToExtent({
            className: "adana-zoom-extent", //'ol-zoom-extent'
            tipLabel: "Haritayı Merkezle",
            extent: ol.proj.transformExtent(
                [24, 36, 48, 42],
                "EPSG:4326",
                "EPSG:3857"
            ),
        });

        var overviewMapControl = new ol.control.OverviewMap({
            // see in overviewmap-custom.html to see the custom CSS used
            className: "ol-overviewmap ol-custom-overviewmap",
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.BingMaps({
                        key:bingKey,
                        imagerySet: "RoadOnDemand",
                        // use maxZoom 19 to see stretched tiles instead of the BingMaps
                        // "no photos at this zoom level" tiles
                        // maxZoom: 19
                    }),
                }),
            ],
            collapseLabel: "\u00BB",
            label: "\u00AB",
            collapsed: false,
        });

        //Instantiate with some options and add the Control
        var bingSearchGeocoder = new Geocoder("nominatim", {
            provider: "bing",
            lang: "en-US",
            placeholder: "Yerleşim Yeri Arayın",
            limit: 5,
            key: bingKey,
            keepOpen: false,
            debug: true,
        });

        // I don't want/need Geocoder layer to be visible
        bingSearchGeocoder.getLayer().setVisible(false);

        //Listen when an address is chosen
        bingSearchGeocoder.on("addresschosen", function (evt) {
            var feature = evt.feature;
            var coord = evt.coordinate;

            // application specific
            //app.addMarker(feature, coord);
        });

        map.addControl(overviewMapControl);
        map.addControl(zoomToExtentControl);
        map.addControl(bingSearchGeocoder);

    // $.ajax('https://geo.anantara.cl/maps/kml/2012-02-10.kml', {
    //     type: 'GET',
    //     headers: {  'Access-Control-Allow-Origin': 'https://geo.anantara.cl'},
    //     contentType: 'application/vnd.google-earth.kml+xml',
    //     crossDomain:true,
    //     success: function (response) {

    //         features = formatKML.readFeatures(response, {
    //             dataProjection: 'EPSG:4326',
    //             featureProjection: 'EPSG:3857'
    //         });

    //         sourceVector.addFeatures(features);
    //     }
    // });


</script>

<style>
.adana-zoom-extent {
    bottom: 60px;
    left: 8px;
    position: absolute;
}

.map .ol-custom-overviewmap,
.map .ol-custom-overviewmap.ol-uncollapsible {
    bottom: 0;
    left: auto;
    right: 0;
    top: auto;
}
</style>